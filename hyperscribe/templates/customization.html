<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hyperscribe Custom Prompts</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2em;
      background-color: #f5f5f5;
      font-size: 14px;
    }
    h4 {
      color: #333;
      font-size: 18px;
    }
    #editor-container {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1.5em;
      margin-top: 2em;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 1.5em;
    }
    label {
      display: block;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 0.5em;
      font-size: 14px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      font-weight: normal;
      margin: 0;
    }
    .checkbox-label input[type="checkbox"] {
      margin-right: 0.5em;
      width: 16px;
      height: 16px;
    }
    .button-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1em;
    }
    #command-select {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
      box-sizing: border-box;
    }
    #prompt-textarea {
      width: 100%;
      min-height: 200px;
      padding: 8px;
      font-family: monospace;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      box-sizing: border-box;
    }
    #save-draft-button, #publish-button {
      padding: 8px 16px;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    #save-draft-button {
      background-color: #95a5a6;
    }
    #save-draft-button:hover {
      background-color: #7f8c8d;
    }
    #save-draft-button:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }
    #publish-button {
      background-color: #27ae60;
    }
    #publish-button:hover {
      background-color: #229954;
    }
    #publish-button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    .message {
      margin-top: 1em;
      padding: 8px;
      border-radius: 4px;
      font-size: 13px;
    }
    .success-message {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    #loading {
      text-align: center;
      font-size: 16px;
      color: #666;
      margin-top: 2em;
    }
  </style>
</head>
<body>
  <h4>Hyperscribe Customization</h4>
  <div id="loading">Loading commands...</div>
  <div id="editor-container" style="display: none;">
    <div class="form-group">
      <label for="command-select">Select Command:</label>
      <select id="command-select"></select>
    </div>
    <div class="form-group">
      <label for="prompt-textarea">Custom Prompt:</label>
      <textarea id="prompt-textarea"></textarea>
    </div>
    <div class="button-row">
      <button id="save-draft-button">Save Draft</button>
      <button id="publish-button">Publish Changes</button>
    </div>
    <div id="message"></div>
  </div>

  <script>
    let commandsData = {};

    async function loadCommands() {
      const loadingDiv = document.getElementById('loading');
      const editorContainer = document.getElementById('editor-container');
      const commandSelect = document.getElementById('command-select');

      try {
        const response = await fetch('{{listCommands | safe}}');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const commandList = await response.json();

        // Convert array to object with command names as keys
        commandsData = {};
        for (const item of commandList) {
          commandsData[item.command] = {
            prompt: item.prompt,
            active: item.active
          };
        }

        loadingDiv.style.display = 'none';
        editorContainer.style.display = 'block';

        // Populate the dropdown with commands
        for (const commandName of Object.keys(commandsData)) {
          const option = document.createElement('option');
          option.value = commandName;
          option.textContent = commandName;
          commandSelect.appendChild(option);
        }

        // Load the first command's prompt if available
        if (Object.keys(commandsData).length > 0) {
          updateTextarea();
        }
      } catch (error) {
        loadingDiv.innerHTML = `<div class="message error-message">Error loading commands: ${error.message}</div>`;
      }
    }

    function updateTextarea() {
      const commandSelect = document.getElementById('command-select');
      const promptTextarea = document.getElementById('prompt-textarea');
      const selectedCommand = commandSelect.value;

      if (selectedCommand && commandsData[selectedCommand] !== undefined) {
        const commandData = commandsData[selectedCommand];
        promptTextarea.value = commandData.prompt || '';
      }
    }

    async function saveCommand(active, buttonId, actionText) {
      const commandSelect = document.getElementById('command-select');
      const promptTextarea = document.getElementById('prompt-textarea');
      const saveDraftButton = document.getElementById('save-draft-button');
      const publishButton = document.getElementById('publish-button');
      const messageDiv = document.getElementById('message');

      const selectedCommand = commandSelect.value;
      const prompt = promptTextarea.value;

      // Clear previous message
      messageDiv.innerHTML = '';
      saveDraftButton.disabled = true;
      publishButton.disabled = true;

      const originalText = document.getElementById(buttonId).textContent;
      document.getElementById(buttonId).textContent = actionText + '...';

      try {
        const response = await fetch('{{saveCommandPromptURL | safe}}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            command: selectedCommand,
            prompt: prompt,
            active: active
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Update local data
        commandsData[selectedCommand] = {
          prompt: prompt,
          active: active
        };

        const statusText = active ? 'published' : 'saved as draft';
        messageDiv.innerHTML = `<div class="message success-message">Successfully ${statusText}!</div>`;
        setTimeout(() => {
          messageDiv.innerHTML = '';
        }, 3000);
      } catch (error) {
        messageDiv.innerHTML = `<div class="message error-message">Error: ${error.message}</div>`;
      } finally {
        saveDraftButton.disabled = false;
        publishButton.disabled = false;
        document.getElementById(buttonId).textContent = originalText;
      }
    }

    async function saveDraft() {
      await saveCommand(false, 'save-draft-button', 'Saving');
    }

    async function publishChanges() {
      await saveCommand(true, 'publish-button', 'Publishing');
    }

    // Load commands when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      loadCommands();

      // Add event listeners
      document.getElementById('command-select').addEventListener('change', updateTextarea);
      document.getElementById('save-draft-button').addEventListener('click', saveDraft);
      document.getElementById('publish-button').addEventListener('click', publishChanges);
    });
  </script>
</body>
</html>