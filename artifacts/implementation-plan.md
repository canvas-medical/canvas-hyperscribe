# Implementation Plan: Hyperscribe Free Text Enhancement

## Summary

**Problem**: When clinicians pre-fill note commands with template text before starting a Hyperscribe session (e.g., "Current concerns with memory or cognition:"), Hyperscribe currently treats this as completed information and may overwrite it rather than using it as a template to fill in.

**Solution**: Detect and preserve pre-filled template text, then pass it to the LLM with special context indicating it should serve as guidance/template for the output.

---

## Change Sets (Ordered by Dependencies)

### Change Set 1: Data Model - Add `prefilled_template` Field to Instruction

**Files Changed:**
- `hyperscribe/structures/instruction.py`

**Description:**
Add a new field `prefilled_template` to the `Instruction` class to store clinician-entered template text separately from LLM-generated `information`.

**Changes:**
1. Add `prefilled_template: str` parameter to `__init__`
2. Update `load_from_json()` to parse `prefilledTemplate` field
3. Update `to_json()` to include `prefilledTemplate` when present
4. Update `__eq__` to compare `prefilled_template`
5. Update `limited_str()` to optionally show template info

**Dependencies:** None

**Test Coverage:**
- Unit tests for `Instruction` serialization/deserialization with `prefilled_template`
- Test `__eq__` comparison with `prefilled_template`

---

### Change Set 2: Extraction - Capture Pre-filled Text at Session Start

**Files Changed:**
- `hyperscribe/libraries/commander.py`

**Description:**
Modify `existing_commands_to_instructions()` to populate `prefilled_template` for pre-initialized commands that have existing content at session start.

**Changes:**
1. In `existing_commands_to_instructions()`, when extracting via `staged_command_extract()`:
   - Set `prefilled_template` to the extracted content
   - Keep `information` empty (or set to same value for backward compatibility)
2. Only set `prefilled_template` for commands that are truly "pre-filled" (not previously generated by Hyperscribe)

**Logic to detect pre-filled vs Hyperscribe-generated:**
- If this is the first cycle (no previous instructions) AND a command has content, it's pre-filled
- Could also use a heuristic: if content looks like a template (contains `:` with nothing after, or placeholder patterns)

**Dependencies:** Change Set 1

**Test Coverage:**
- Test `existing_commands_to_instructions()` sets `prefilled_template` for pre-filled commands
- Test `prefilled_template` is empty for commands generated by Hyperscribe
- Test backward compatibility when no template text exists

---

### Change Set 3: LLM Context - Pass Template to Instruction Detection

**Files Changed:**
- `hyperscribe/libraries/audio_interpreter.py`

**Description:**
Modify instruction detection to inform the LLM about pre-filled template text so it treats it as guidance rather than information to replace.

**Changes:**
1. In `detect_instructions_flat()`:
   - When building the user prompt with `known_instructions`, check for `prefilled_template`
   - Add special context for instructions with templates:
     ```
     "The text in this field was entered by the clinician before the visit.
     This text is guidance that the clinician is providing to the scribe and
     should serve as a template for the output placed in this command."
     ```
2. Similarly update `detect_instructions_per_section()` if hierarchical detection is used

**Dependencies:** Change Set 2

**Test Coverage:**
- Test that prompt includes template context when `prefilled_template` is present
- Test that prompt excludes template context when `prefilled_template` is empty
- Test with multiple commands where some have templates and some don't

---

### Change Set 4: Parameter Generation - Use Template as Structure Guidance

**Files Changed:**
- `hyperscribe/libraries/audio_interpreter.py`

**Description:**
Modify `create_sdk_command_parameters()` to include the pre-filled template in the LLM prompt, instructing it to use the template structure when generating parameters.

**Changes:**
1. In `create_sdk_command_parameters()`:
   - Check if the instruction has a `prefilled_template`
   - If present, add to user prompt:
     ```
     "The clinician pre-filled this command with the following template text:
     ```text
     {prefilled_template}
     ```
     Use this text as a structural template. Fill in the placeholders and
     complete the sections while preserving the clinician's intended format
     and headings."
     ```

**Dependencies:** Change Set 3

**Test Coverage:**
- Test parameter generation includes template guidance when present
- Test parameter generation works normally when no template
- Integration test: template structure is preserved in output

---

### Change Set 5: (Optional) Heuristic Detection for Template Text

**Files Changed:**
- `hyperscribe/libraries/helper.py` (new method) or `hyperscribe/structures/instruction.py`

**Description:**
Add a helper method to detect if text looks like a template (has unfilled sections) vs completed content.

**Heuristic patterns:**
- Lines ending with `:` followed by nothing or whitespace
- Common placeholder patterns: `[...]`, `___`, `<placeholder>`
- Section headers without content below them

**Changes:**
1. Add `is_template_text(text: str) -> bool` method
2. Use this in Change Set 2 to determine if content is truly a template

**Dependencies:** None (can be developed in parallel)

**Test Coverage:**
- Test various template patterns are detected
- Test completed content is not flagged as template
- Edge cases: mixed content with some filled sections

---

## Implementation Sequence

```
Change Set 1 (Data Model)
         │
         ▼
Change Set 2 (Extraction)
         │
         ▼
Change Set 3 (Instruction Detection)
         │
         ▼
Change Set 4 (Parameter Generation)

Change Set 5 (Heuristic Detection) ────┐
                                       │
                                       ▼
                          Can be integrated into Change Set 2
```

---

## Detailed File Changes Summary

| File | Change Sets | Type of Change |
|------|-------------|----------------|
| `structures/instruction.py` | 1 | Add field, update serialization |
| `libraries/commander.py` | 2 | Extract & populate template field |
| `libraries/audio_interpreter.py` | 3, 4 | Add template context to prompts |
| `libraries/helper.py` | 5 (optional) | Add template detection heuristic |

---

## Testing Strategy

### Unit Tests (per Change Set)

1. **Change Set 1:** `tests/structures/test_instruction.py`
   - Serialization roundtrip with `prefilled_template`

2. **Change Set 2:** `tests/libraries/test_commander.py`
   - `existing_commands_to_instructions()` with pre-filled commands

3. **Change Set 3-4:** `tests/libraries/test_audio_interpreter.py`
   - Prompt generation with/without templates

### Integration Test

- End-to-end test: Create a note with pre-filled HPI template text, run Hyperscribe session, verify template structure is preserved in output

---

## Rollout Considerations

1. **Backward Compatibility:** `prefilled_template` should default to empty string; existing behavior unchanged when no template detected
2. **No New Secrets Required:** Uses existing custom prompt infrastructure
3. **No Database Changes:** All changes are in-memory instruction handling
4. **Gradual Rollout:** Could add a feature flag secret `EnableTemplateDetection` if needed

---

## Risk Assessment

| Risk | Mitigation |
|------|------------|
| False positive template detection | Use conservative heuristics; only detect obvious patterns |
| Over-preservation of template | Clear LLM instructions to fill in, not just preserve |
| Regression in non-template cases | Extensive unit tests; `prefilled_template` empty by default |
| Performance impact | Minimal; one additional string field per instruction |

---

## Estimated Scope

- **Change Set 1:** Small (~20 lines)
- **Change Set 2:** Medium (~40 lines)
- **Change Set 3:** Medium (~30 lines)
- **Change Set 4:** Medium (~25 lines)
- **Change Set 5:** Small (~30 lines, optional)
- **Tests:** ~150-200 lines total

**Total:** ~300-350 lines of production code + tests
